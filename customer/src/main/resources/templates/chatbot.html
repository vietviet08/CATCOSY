<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CATCOSY - Chatbot Hỗ Trợ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #e83e8c;
            --secondary-color: #6f42c1;
            --light-bg: #f8f9fa;
            --dark-bg: #343a40;
        }
        
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .chat-container {
            max-width: 800px;
            margin: 20px auto;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }
        
        .chat-header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-messages {
            height: 500px;
            overflow-y: auto;
            padding: 15px;
            background-color: white;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 80%;
            position: relative;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-message {
            background-color: var(--primary-color);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
            text-align: right;
        }
        
        .bot-message {
            background-color: var(--light-bg);
            color: #333;
            margin-right: auto;
            border-bottom-left-radius: 5px;
        }
        
        .message-time {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-top: 5px;
        }
        
        .chat-input {
            display: flex;
            padding: 15px;
            background-color: white;
            border-top: 1px solid #ddd;
        }
        
        .chat-input input {
            flex-grow: 1;
            border: 1px solid #ddd;
            border-radius: 20px;
            padding: 10px 15px;
            margin-right: 10px;
            outline: none;
        }
        
        .chat-input button {
            border: none;
            background-color: var(--primary-color);
            color: white;
            border-radius: 20px;
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .chat-input button:hover {
            background-color: #d82d7e;
        }
        
        .chat-input button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .typing-indicator {
            display: inline-block;
            padding: 10px 15px;
            background-color: #f0f0f0;
            border-radius: 18px;
            margin-bottom: 15px;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.4; }
            50% { opacity: 1; }
            100% { opacity: 0.4; }
        }
        
        .dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #777;
            border-radius: 50%;
            margin-right: 3px;
            animation: bounce 1.5s infinite;
        }
        
        .dot:nth-child(2) { animation-delay: 0.2s; }
        .dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        .source-indicator {
            font-size: 0.75rem;
            font-style: italic;
            margin-top: 5px;
            opacity: 0.7;
        }
        
        .clear-button {
            background-color: transparent;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="chat-container">
            <div class="chat-header">
                <div>CATCOSY Chatbot Hỗ Trợ</div>
                <button id="clearChat" class="clear-button">
                    <i class="fas fa-trash-alt"></i> Xóa cuộc trò chuyện
                </button>
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="message bot-message">
                    Xin chào! Tôi là trợ lý ảo của CATCOSY. Tôi có thể giúp gì cho bạn về các sản phẩm thời trang, xu hướng, hoặc giải đáp thắc mắc của bạn?
                    <div class="message-time">Hôm nay, lúc 00:00</div>
                </div>
            </div>
            <div class="chat-input">
                <input type="text" id="messageInput" placeholder="Nhập tin nhắn của bạn..." autofocus>
                <button id="sendButton">
                    <i class="fas fa-paper-plane"></i> Gửi
                </button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Các elements
            const chatMessages = document.getElementById('chatMessages');
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            const clearButton = document.getElementById('clearChat');
            
            // Cấu hình
            const apiBasePath = window.location.origin;
            
            // Log cấu hình
            console.log("API Base Path:", apiBasePath);
            
            // Tạo userId ngẫu nhiên cho mỗi phiên
            const userId = 'user-' + Math.random().toString(36).substring(2, 10);
            console.log("Generated User ID:", userId);
            
            // Lịch sử cuộc trò chuyện
            let conversationHistory = [];
            
            // Hiển thị thời gian
            function formatTime() {
                const now = new Date();
                const hours = now.getHours().toString().padStart(2, '0');
                const minutes = now.getMinutes().toString().padStart(2, '0');
                return `Hôm nay, lúc ${hours}:${minutes}`;
            }
            
            // Thêm tin nhắn vào giao diện
            function addMessage(content, isUser, source = null) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
                
                messageDiv.innerHTML = `
                    ${content}
                    <div class="message-time">${formatTime()}</div>
                    ${source ? `<div class="source-indicator">Nguồn: ${source}</div>` : ''}
                `;
                
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            // Hiển thị chỉ báo đang nhập
            function showTypingIndicator() {
                const indicator = document.createElement('div');
                indicator.id = 'typingIndicator';
                indicator.className = 'typing-indicator';
                indicator.innerHTML = `
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                `;
                chatMessages.appendChild(indicator);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            // Ẩn chỉ báo đang nhập
            function hideTypingIndicator() {
                const indicator = document.getElementById('typingIndicator');
                if (indicator) {
                    indicator.remove();
                }
            }
            
            // Gửi tin nhắn đến API
            async function sendMessage(message) {
                try {
                    console.log("Sending message to API...");
                    // Hiển thị chỉ báo đang nhập
                    showTypingIndicator();
                    
                    // Vô hiệu hóa nút gửi
                    sendButton.disabled = true;
                    
                    // Chuẩn bị dữ liệu gửi đi
                    const payload = {
                        message: message,
                        userId: userId,
                        conversationHistory: conversationHistory
                    };
                    
                    console.log("Request payload:", payload);
                    
                    // Tạo đường dẫn API đầy đủ
                    const apiUrl = apiBasePath + '/api/chatbot/send';
                    console.log("API URL:", apiUrl);
                    
                    // Gọi API
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });
                    
                    console.log("Response status:", response.status);
                    
                    // Xử lý kết quả
                    if (response.ok) {
                        const data = await response.json();
                        console.log("API response:", data);
                        
                        // Ẩn chỉ báo đang nhập
                        hideTypingIndicator();
                        
                        // Cập nhật lịch sử trò chuyện
                        conversationHistory = data.conversationHistory;
                        
                        // Hiển thị phản hồi
                        addMessage(data.message, false, data.source);
                    } else {
                        // Xử lý lỗi
                        console.error('Error status:', response.status, response.statusText);
                        hideTypingIndicator();
                        try {
                            const errorText = await response.text();
                            console.error('Error response:', errorText);
                        } catch (e) {
                            console.error('Could not read error response');
                        }
                        addMessage('Đã có lỗi xảy ra. Vui lòng thử lại sau. (Mã lỗi: ' + response.status + ')', false, 'error');
                    }
                } catch (error) {
                    // Xử lý lỗi mạng
                    console.error('Network Error:', error);
                    hideTypingIndicator();
                    
                    // Gọi API trực tiếp từ GeminiService
                    try {
                        // Mô phỏng phản hồi từ API khi không thể kết nối
                        const simulatedResponse = simulateResponse(message);
                        hideTypingIndicator();
                        addMessage(simulatedResponse, false, 'local');
                    } catch (e) {
                        addMessage('Không thể kết nối đến máy chủ. Vui lòng kiểm tra kết nối mạng và thử lại.', false, 'error');
                    }
                } finally {
                    // Kích hoạt lại nút gửi
                    sendButton.disabled = false;
                }
            }
            
            // Mô phỏng phản hồi khi không thể kết nối API
            function simulateResponse(prompt) {
                prompt = prompt.toLowerCase();
                
                if (prompt.includes("chào") || prompt.includes("hi") || prompt.includes("hello")) {
                    return "Xin chào! Tôi là trợ lý ảo của CATCOSY. Rất vui được hỗ trợ bạn hôm nay. Tôi có thể giúp gì cho bạn về các sản phẩm thời trang của chúng tôi?";
                } else if (prompt.includes("xu hướng thời trang")) {
                    return "Xu hướng thời trang năm 2025 đang hướng đến sự bền vững và tính ứng dụng cao. Các màu sắc tự nhiên, chất liệu thân thiện với môi trường, và thiết kế tối giản đang rất được ưa chuộng. CATCOSY tự hào giới thiệu bộ sưu tập mới nhất của chúng tôi phản ánh những xu hướng này.";
                } else {
                    return "Cảm ơn bạn đã liên hệ với CATCOSY! Chúng tôi chuyên cung cấp các sản phẩm thời trang chất lượng cao, bền vững và hợp thời trang. Hiện tại chúng tôi đang gặp một số vấn đề kỹ thuật. Bạn vui lòng thử lại sau nhé!";
                }
            }
            
            // Kiểm tra kết nối API ngay khi trang tải xong
            async function checkApiConnection() {
                try {
                    const testUrl = apiBasePath + '/api/chatbot/test';
                    console.log("Testing API connection:", testUrl);
                    
                    const response = await fetch(testUrl);
                    
                    if (response.ok) {
                        const data = await response.text();
                        console.log("API test successful:", data);
                        return true;
                    } else {
                        console.error("API test failed:", response.status, response.statusText);
                        return false;
                    }
                } catch (error) {
                    console.error("API connection error:", error);
                    return false;
                }
            }
            
            // Xử lý sự kiện gửi tin nhắn
            function handleSend() {
                const message = messageInput.value.trim();
                if (message) {
                    // Thêm tin nhắn của người dùng vào giao diện
                    addMessage(message, true);
                    
                    // Gửi tin nhắn đến API
                    sendMessage(message);
                    
                    // Xóa nội dung input
                    messageInput.value = '';
                }
            }
            
            // Xử lý sự kiện xóa cuộc trò chuyện
            async function handleClear() {
                try {
                    // Gọi API xóa lịch sử
                    const clearUrl = apiBasePath + `/api/chatbot/history/${userId}`;
                    
                    try {
                        const response = await fetch(clearUrl, {
                            method: 'DELETE'
                        });
                        
                        if (response.ok) {
                            console.log("History cleared successfully");
                        } else {
                            console.error("Failed to clear history:", response.status, response.statusText);
                        }
                    } catch (error) {
                        console.error("Error clearing history:", error);
                    }
                    
                    // Xóa lịch sử trong bộ nhớ bất kể API có thành công hay không
                    conversationHistory = [];
                    
                    // Xóa tin nhắn trên giao diện
                    chatMessages.innerHTML = '';
                    
                    // Thêm tin nhắn chào mừng
                    addMessage('Xin chào! Tôi là trợ lý ảo của CATCOSY. Tôi có thể giúp gì cho bạn về các sản phẩm thời trang, xu hướng, hoặc giải đáp thắc mắc của bạn?', false);
                } catch (error) {
                    console.error('Error clearing chat:', error);
                }
            }
            
            // Đăng ký sự kiện
            sendButton.addEventListener('click', handleSend);
            messageInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    handleSend();
                }
            });
            clearButton.addEventListener('click', handleClear);
            
            // Kiểm tra kết nối API ngay khi trang tải xong
            checkApiConnection().then(isConnected => {
                if (!isConnected) {
                    console.log("API connection failed, using local mode");
                }
            });
        });
    </script>
</body>
</html>